
var MapTextureConfig =[
     {textag:1,name:"tag1_png"},
     {textag:2,name:"tag2_png"},
     {textag:3,name:"tag3_png"},
     {textag:4,name:"tag4_png"}
]


var MapConfig = [
    {x:0,y:0,canW:true,textag:0},
    {x:1,y:0,canW:true,textag:0},
    {x:2,y:0,canW:true,textag:0},
    {x:3,y:0,canW:true,textag:0},
    {x:4,y:0,canW:true,textag:0},
    {x:5,y:0,canW:true,textag:0},
    {x:6,y:0,canW:true,textag:0},
    {x:7,y:0,canW:true,textag:0},

    {x:0,y:1,canW:true,textag:0},
    {x:1,y:1,canW:true,textag:0},
    {x:2,y:1,canW:true,textag:0},
    {x:3,y:1,canW:true,textag:0},
    {x:4,y:1,canW:true,textag:0},
    {x:5,y:1,canW:true,textag:0},
    {x:6,y:1,canW:true,textag:0},
    {x:7,y:1,canW:true,textag:0},
    
    {x:0,y:2,canW:false,textag:0},
    {x:1,y:2,canW:false,textag:0},
    {x:2,y:2,canW:false,textag:0},
    {x:3,y:2,canW:true,textag:0},
    {x:4,y:2,canW:true,textag:0},
    {x:5,y:2,canW:false,textag:0},
    {x:6,y:2,canW:false,textag:0},
    {x:7,y:2,canW:false,textag:0},

    {x:0,y:3,canW:true,textag:0},
    {x:1,y:3,canW:true,textag:0},
    {x:2,y:3,canW:false,textag:3},
    {x:3,y:3,canW:true,textag:0},
    {x:4,y:3,canW:true,textag:0},
    {x:5,y:3,canW:true,textag:0},
    {x:6,y:3,canW:true,textag:0},
    {x:7,y:3,canW:true,textag:0},

    {x:0,y:4,canW:true,textag:0},
    {x:1,y:4,canW:true,textag:0},
    {x:2,y:4,canW:false,textag:2},
    {x:3,y:4,canW:false,textag:1},
    {x:4,y:4,canW:false,textag:3},
    {x:5,y:4,canW:false,textag:2},
    {x:6,y:4,canW:true,textag:0},
    {x:7,y:4,canW:true,textag:0},

    {x:0,y:5,canW:true,textag:0},
    {x:1,y:5,canW:true,textag:0},
    {x:2,y:5,canW:true,textag:0},
    {x:3,y:5,canW:true,textag:0},
    {x:4,y:5,canW:true,textag:0},
    {x:5,y:5,canW:true,textag:0},
    {x:6,y:5,canW:true,textag:0},
    {x:7,y:5,canW:true,textag:0},

    {x:0,y:6,canW:true,textag:0},
    {x:1,y:6,canW:true,textag:0},
    {x:2,y:6,canW:true,textag:0},
    {x:3,y:6,canW:true,textag:0},
    {x:4,y:6,canW:true,textag:0},
    {x:5,y:6,canW:true,textag:0},
    {x:6,y:6,canW:true,textag:0},
    {x:7,y:6,canW:true,textag:0},

    {x:0,y:7,canW:true,textag:0},
    {x:1,y:7,canW:true,textag:0},
    {x:2,y:7,canW:true,textag:0},
    {x:3,y:7,canW:true,textag:0},
    {x:4,y:7,canW:true,textag:0},
    {x:5,y:7,canW:true,textag:0},
    {x:6,y:7,canW:true,textag:0},
    {x:7,y:7,canW:true,textag:0},

    {x:0,y:8,canW:true,textag:0},
    {x:1,y:8,canW:true,textag:0},
    {x:2,y:8,canW:true,textag:0},
    {x:3,y:8,canW:true,textag:0},
    {x:4,y:8,canW:true,textag:0},
    {x:5,y:8,canW:true,textag:0},
    {x:6,y:8,canW:true,textag:0},
    {x:7,y:8,canW:true,textag:0},

    {x:0,y:9,canW:true,textag:0},
    {x:1,y:9,canW:true,textag:0},
    {x:2,y:9,canW:false,textag:1},
    {x:3,y:9,canW:false,textag:2},
    {x:4,y:9,canW:false,textag:3},
    {x:5,y:9,canW:false,textag:2},
    {x:6,y:9,canW:true,textag:0},
    {x:7,y:9,canW:true,textag:0},

    {x:0,y:10,canW:true,textag:0},
    {x:1,y:10,canW:true,textag:0},
    {x:2,y:10,canW:true,textag:0},
    {x:3,y:10,canW:true,textag:0},
    {x:4,y:10,canW:true,textag:0},
    {x:5,y:10,canW:false,textag:3},
    {x:6,y:10,canW:true,textag:0},
    {x:7,y:10,canW:true,textag:0},

    {x:0,y:11,canW:false,textag:0},
    {x:1,y:11,canW:false,textag:0},
    {x:2,y:11,canW:false,textag:0},
    {x:3,y:11,canW:true,textag:0},
    {x:4,y:11,canW:true,textag:0},
    {x:5,y:11,canW:false,textag:0},
    {x:6,y:11,canW:false,textag:0},
    {x:7,y:11,canW:false,textag:0},

    {x:0,y:12,canW:true,textag:0},
    {x:1,y:12,canW:true,textag:0},
    {x:2,y:12,canW:true,textag:0},
    {x:3,y:12,canW:true,textag:0},
    {x:4,y:12,canW:true,textag:0},
    {x:5,y:12,canW:true,textag:0},
    {x:6,y:12,canW:true,textag:0},
    {x:7,y:12,canW:true,textag:0},

    {x:0,y:13,canW:true,textag:0},
    {x:1,y:13,canW:true,textag:0},
    {x:2,y:13,canW:true,textag:0},
    {x:3,y:13,canW:true,textag:0},
    {x:4,y:13,canW:true,textag:0},
    {x:5,y:13,canW:true,textag:0},
    {x:6,y:13,canW:true,textag:0},
    {x:7,y:13,canW:true,textag:0},


]


class MapTile {
   public x:number;
   public y:number;
   public canW:boolean;
   public textag:number;
}

class MainMap extends egret.DisplayObjectContainer {
    public TileSize=80;
    public  MapTiles:Array<MapTile>=new Array<MapTile>();
    public  MapViews:Array<egret.DisplayObjectContainer>=new Array<egret.DisplayObjectContainer>();
    public W=0;
    public H=0;
    constructor(){
        super();
        this.LoadKs();
   //   RES.loadConfig("Ditu.ts");
        this.LoadCs();
        this.touchEnabled=true;
        
    }
    private LoadKs() {
        var OneK:MapTile;
        for(var i=0;i<MapConfig.length;i++) {
            OneK=MapConfig[i];          
            this.MapTiles.push(OneK);
            this.W=OneK.x+1;
            this.H=OneK.y+1;
        }
    }
     private LoadCs() {
        var OneC:egret.DisplayObjectContainer;
        for(var i=0;i<this.MapTiles.length;i++) {
            OneC=new egret.DisplayObjectContainer; 
            OneC.x=this.MapTiles[i].x*this.TileSize;
            OneC.y=this.MapTiles[i].y*this.TileSize;
            if(this.MapTiles[i].textag!=0) {
            var oneBit=this.createBitmapByName(this.LoadTu(this.MapTiles[i]));
             OneC.addChild(oneBit);
           
            }
            this.MapViews.push(OneC);
            this.addChild(OneC);  
           
        }
    }
     private LoadTu(MK:MapTile):string {
         
         var name:string=MapTextureConfig[MK.textag-1].name;
         return name;

} 

 private createBitmapByName(name:string):egret.Bitmap {
        var result = new egret.Bitmap();
        var texture:egret.Texture = RES.getRes(name);
        result.texture = texture;
        return result;
    }
}



class node {
    public x:number;
    public y:number;
    public f:number;
    public g:number;
    public h:number;
    public fn:node;
}

class Astar {
    public StartN:node=new node();
    public EndN:node=new node();;
    private nowN:node=new node();
    public IsOk=false;
    public EndNcanW=false;
    private W:number;
    private H:number;
    private Player:Pole;
    private BM:MainMap;
    public path:Array<node>=new Array<node>();
    private O:Array<node>=new Array<node>();
    private C:Array<node>=new Array<node>();

    constructor(BM:MainMap,Pl:Pole) {
        this.H=BM.H;
        this.W=BM.W;
        this.BM=BM;
        this.Player=Pl;
    }
   
    public findPath(tx:number,ty:number) {
        this.path=new Array<node>();
        this.O=new Array<node>();
        this.C=new Array<node>();
        this.IsOk=false;
        this.EndNcanW=true;
    //    console.log("数组初始化完毕");
        this.EndN.x=tx;
        this.EndN.y=ty;
        this.StartN.x=Math.floor( this.Player.x/this.BM.TileSize);
        this.StartN.y=Math.floor( this.Player.y/this.BM.TileSize);
        this.StartN.g=0;
        this.StartN.fn=this.StartN;
        this.nowN=this.StartN;
        this.sh(this.StartN);
        this.sf(this.StartN);
        this.O.push(this.StartN);
        
   

         if(this.isF(this.EndN)) {
             this.EndNcanW=false;
    //     console.log("终点不可走");
         }
    //     console.log("起点：x:"+this.nowN.x+"y:"+this.nowN.y);
    //     console.log("终点：x:"+this.EndN.x+"y:"+this.EndN.y);
        

         if(this.nowN.x==this.EndN.x&&this.nowN.y==this.EndN.y) {
             this.IsOk=true;
             this.EndN.fn=this.nowN;
         }

          var t=0;
        do{
            this.nowN=this.getgoodN();
            this.ZhaozhouweiN(this.nowN);
            this.C.push(this.nowN);    
            t++;
            if(this.O.length<=0 ||this.IsOk) {
                     break;
            }
           
    //    console.log("循环中...");
        }while(this.EndNcanW);
      //  console.log("第一个wh用了："+t);
      //  console.log("额外点赛了："+this.u);
        var Psfan:Array<node>=new Array<node>();
        if(this.EndNcanW) {
          Psfan.push(this.EndN);
        }
    

        do{
            Psfan.push(this.nowN);
         
            if(this.nowN.fn.x==this.StartN.x&&this.nowN.fn.y==this.StartN.y){break;}
            this.nowN=this.nowN.fn;
   //     console.log(" 数组...");
        }while(this.EndNcanW);

        var j=0;
        for(var i=Psfan.length;i>0;i--) {
            this.path.push(Psfan[i-1]);
    //        console.log("x:"+this.Ps[j].x+"y:"+this.Ps[j].y);
            this.path[j].x=this.path[j].x*this.BM.TileSize+this.BM.TileSize/2;
            this.path[j].y=this.path[j].y*this.BM.TileSize+this.BM.TileSize/2;
            j++;
        }
     //   console.log("计算完毕");
       

    }
    public ZhaozhouweiN(n:node) {
        this.AddNtoO(n,n.x-1,n.y-1);
        this.AddNtoO(n,n.x,n.y-1);
        this.AddNtoO(n,n.x+1,n.y-1);
        this.AddNtoO(n,n.x-1,n.y);
        this.AddNtoO(n,n.x+1,n.y);
        this.AddNtoO(n,n.x-1,n.y+1);
        this.AddNtoO(n,n.x,n.y+1);
        this.AddNtoO(n,n.x+1,n.y+1);
        
    }

    public u=0;
    public AddNtoO(fn:node,x:number,y:number) {
        if(x<0||y<0||x>=this.W||y>=this.H){return;}
        var n:node=new node();
        n.x=x;
        n.y=y;

        

        if(this.IsinC(n)||this.isF(n)||this.IsinO(n)) {
            return ;
        }else {
            n.fn=fn;
            this.sg(n);this.sh(n);this.sf(n);
            this.O.push(n);

            this.u++;
    
            if(this.EndN.x==n.x&&this.EndN.y==n.y) {
                this.IsOk=true;
            }
        }

    }
    public IsinO(n:node):boolean{
        for(var i=0;i<this.O.length;i++) {
            if(n.x==this.O[i].x&&n.y==this.O[i].y)
                return true;
        }
        return false ;
    }
    public IsinC(n:node):boolean{
        for(var i=0;i<this.C.length;i++) {
            if(n.x==this.C[i].x&&n.y==this.C[i].y)
                return true;
        }
        return false ;
        
    }
    public isF(n:node):boolean{
        for(var i=0;i<this.BM.MapTiles.length;i++) {
            if(n.x==this.BM.MapTiles[i].x&&n.y==this.BM.MapTiles[i].y&&this.BM.MapTiles[i].canW==false) {
                return true;
            }
        }
        return false;
    }
    public sh(n:node) {
        var xx=Math.max(n.x,this.EndN.x)-Math.min(n.x,this.EndN.x);
        var yy=Math.max(n.y,this.EndN.y)-Math.min(n.y,this.EndN.y);
        n.h=xx+yy;
    }
    public sg(n:node) {
       if(n.x!=n.fn.x&&n.y !=n.fn.y) {
           n.g=n.fn.g+1.4;
       }else {
           n.g=n.fn.g+1;
       }
       
    }
    public sf(n:node) {
        n.f=n.g+n.h;
    }
    public getgoodN():node { 
        var gn:node;
        var gf=999;
        var k:number;
        for(var i=0;i<this.O.length;i++) {
            if(this.O[i].f<gf) {
                gf=this.O[i].f;
                k=i;
            }
        }
        gn=this.O[k];
        this.O[k]=this.O[0];
        this.O[0]=gn;      
        return this.O.shift();
    }

}

